<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>èªéŸ³é‹å‹•è™•æ–¹ åŠ©ç†</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f6f8fc;
        text-align: center;
        padding: 20px;
    }

    h1 {
        font-size: 26px;
        margin-bottom: 25px;
    }

    #recordBtn {
        width: 220px;
        height: 220px;
        background: #e74c3c;
        color: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 28px;
        cursor: pointer;
        user-select: none;
        margin: 0 auto 30px auto;
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    #wave {
        width: 90%;
        height: 160px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        margin: 0 auto 25px auto;
    }

    .bubble {
        width: 90%;
        margin: 10px auto;
        padding: 15px;
        border-radius: 10px;
        font-size: 20px;
        text-align: left;
    }

    .userTxt { border-left: 5px solid #3498db; background: #eef6ff; }
    .aiTxt   { border-left: 5px solid #2ecc71; background: #eafff3; }

</style>
</head>
<body>

<h1>ğŸ¤ èªéŸ³é‹å‹•è™•æ–¹ åŠ©ç† 251117 13:20</h1>

<div id="recordBtn">é–‹å§‹éŒ„éŸ³</div>

<canvas id="wave"></canvas>

<div id="userText" class="bubble userTxt">(è«‹é–‹å§‹èªªè©±â€¦)</div>
<div id="aiText" class="bubble aiTxt">(ç­‰å¾…ç³»çµ±å›è¦†â€¦)</div>

<audio id="audioPlayer"></audio>

<script>
/*************************************************
 * ğŸ”‘ 1. è¨­å®š Dify APP API Keyï¼ˆä½ çš„ï¼‰
 *************************************************/
const DIFY_API_KEY = "Bearer app-1WyIJ3hJBXRWb8DbTB7cbiWA";

/*************************************************
 * ğŸ”— 2. è¨­å®š ChatBot Public URLï¼ˆä½ æä¾›çš„ï¼‰
 *************************************************/
const DIFY_PUBLIC_CHATBOT = "https://udify.app/chatbot/rwwFAvWgLAzzOl1P";

/*************************************************
 * ğŸ§  3. Dify chat-messages APIï¼ˆå›ºå®šï¼‰
 *************************************************/
const DIFY_CHAT_API = "https://api.dify.ai/v1/chat-messages";

let mediaRecorder, audioChunks = [];
let audioContext, analyser, dataArray;
let conversationId = null;

/*************************************************
 * ğŸ›ï¸ å»ºç«‹å³æ™‚éŸ³æ³¢
 *************************************************/
function setupWaveform() {
    const canvas = document.getElementById("wave");
    const ctx = canvas.getContext("2d");

    function draw() {
        requestAnimationFrame(draw);
        if (!analyser) return;

        analyser.getByteTimeDomainData(dataArray);

        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.lineWidth = 3;
        ctx.strokeStyle = "#3498db";
        ctx.beginPath();

        const sliceWidth = canvas.width / dataArray.length;
        let x = 0;

        for (let i = 0; i < dataArray.length; i++) {
            let v = dataArray[i] / 128.0;
            let y = (v * canvas.height) / 2;

            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);

            x += sliceWidth;
        }

        ctx.stroke();
    }
    draw();
}

/*************************************************
 * ğŸ™ï¸ é–‹å§‹éŒ„éŸ³
 *************************************************/
async function startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    audioChunks = [];

    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start();

    // ğŸµ å»ºç«‹æ³¢å½¢åˆ†æå™¨
    audioContext = new AudioContext();
    const source = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    source.connect(analyser);

    setupWaveform();

    document.getElementById("recordBtn").textContent = "åœæ­¢éŒ„éŸ³";

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
}

/*************************************************
 * â¹ï¸ åœæ­¢éŒ„éŸ³ä¸¦é€åˆ° Dify
 *************************************************/
function stopRecording() {
    mediaRecorder.stop();

    mediaRecorder.onstop = async () => {
        const blob = new Blob(audioChunks, { type: "audio/webm" });
        sendToDify(blob);
        document.getElementById("recordBtn").textContent = "é–‹å§‹éŒ„éŸ³";
    };
}

/*************************************************
 * ğŸ” å‘¼å« Difyï¼ˆå« sys.files èªéŸ³ï¼‰
 *************************************************/
async function sendToDify(blob) {
    const form = new FormData();
    form.append("response_mode", "blocking");
    form.append("user", "voice-user-001");
    if (conversationId) form.append("conversation_id", conversationId);

    // ğŸ“Œ sys.files
    form.append("file", blob, "audio.webm");

    const resp = await fetch(DIFY_CHAT_API, {
        method: "POST",
        headers: {
            Authorization: DIFY_API_KEY
        },
        body: form
    });

    const data = await resp.json();

    if (resp.status !== 200) {
        alert("âŒ Dify å›æ‡‰éŒ¯èª¤ï¼š" + resp.status + " - " + JSON.stringify(data));
        return;
    }

    conversationId = data.conversation_id;

    document.getElementById("userText").textContent =
        data.inputs?.voice_text || "(èªéŸ³è¾¨è­˜ä¸­...)";

    document.getElementById("aiText").textContent =
        data.answer || "(AI æ²’æœ‰å›è¦†æ–‡å­—)";

    if (data.audio) {
        const audioPlayer = document.getElementById("audioPlayer");
        const audioBlob = await fetch(data.audio).then(r => r.blob());
        audioPlayer.src = URL.createObjectURL(audioBlob);
        audioPlayer.play();
    }
}

/*************************************************
 * ğŸ›ï¸ æŒ‰éˆ•æ§åˆ¶
 *************************************************/
const btn = document.getElementById("recordBtn");
let isRecording = false;

btn.onclick = () => {
    if (!isRecording) {
        startRecording();
        isRecording = true;
    } else {
        stopRecording();
        isRecording = false;
    }
};
</script>

</body>
</html>
