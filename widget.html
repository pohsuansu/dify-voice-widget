<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>èªéŸ³ç‰ˆé‹å‹•è™•æ–¹</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- WaveSurfer 7ï¼ˆç”¨æ–¼é¡¯ç¤ºéŒ„éŸ³å¾Œçš„æ³¢å½¢ï¼‰ -->
<script src="https://unpkg.com/wavesurfer.js"></script>

<style>
  body {
    font-family: "Noto Sans TC", sans-serif;
    background: #f5f7fb;
    padding: 20px;
    text-align: center;
  }
  #recordBtn {
    width: 160px;
    height: 160px;
    border-radius: 50%;
    border: none;
    background: #ef4444;
    color: white;
    font-size: 24px;
    cursor: pointer;
    margin-top: 20px;
  }
  #recordBtn.recording {
    background: #10b981;
  }
  #waveform {
    width: 100%;
    max-width: 700px;
    height: 120px;
    margin: 20px auto;
    background: #e2e8f0;
    border-radius: 8px;
  }
  .bubble {
    padding: 12px;
    margin: 10px auto;
    max-width: 700px;
    border-radius: 8px;
    background: #fff;
    text-align: left;
  }
  .user { border-left: 4px solid #3b82f6; }
  .ai   { border-left: 4px solid #10b981; }
</style>
</head>

<body>

<h2>ğŸ™ï¸ èªéŸ³é‹å‹•è™•æ–¹ åŠ©ç† 251117_12:24</h2>

<button id="recordBtn">é–‹å§‹éŒ„éŸ³</button>

<div id="waveform"></div>

<div id="userText" class="bubble user"></div>
<div id="aiText" class="bubble ai"></div>

<audio id="audioPlayer" controls></audio>

<script>
/************************************************************
 * ğŸ” è¨­å®š
 ************************************************************/
const DIFY_API_KEY = "YOUR_DIFY_API_KEY";  // â† ä½ çš„ app Key
const USER_ID = "u-" + Math.random().toString(36).slice(2);
let conversationId = "";

/************************************************************
 * ğŸ§ WaveSurfer åˆå§‹åŒ–ï¼ˆä¸ä½¿ç”¨éº¥å…‹é¢¨ pluginï¼‰
 ************************************************************/
let wavesurfer = WaveSurfer.create({
  container: "#waveform",
  waveColor: "#94a3b8",
  progressColor: "#0ea5e9",
  cursorWidth: 0,
});

/************************************************************
 * ğŸ™ éŒ„éŸ³ï¼šä½¿ç”¨ MediaRecorderï¼ˆä¸éœ€è¦ WaveSurfer microphoneï¼‰
 ************************************************************/
let mediaRecorder;
let audioChunks = [];

const recordBtn = document.getElementById("recordBtn");

recordBtn.addEventListener("click", async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    startRecording();
  } else {
    stopRecording();
  }
});

async function startRecording() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  audioChunks = [];
  mediaRecorder = new MediaRecorder(stream);

  mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);

  mediaRecorder.onstop = async () => {
    const blob = new Blob(audioChunks, { type: "audio/webm" });

    wavesurfer.loadBlob(blob);  // â† é¡¯ç¤ºæ³¢å½¢

    await sendToDify(blob);
    stream.getTracks().forEach(t => t.stop());
  };

  mediaRecorder.start();
  recordBtn.textContent = "åœæ­¢éŒ„éŸ³";
  recordBtn.classList.add("recording");
}

function stopRecording() {
  mediaRecorder.stop();
  recordBtn.textContent = "é–‹å§‹éŒ„éŸ³";
  recordBtn.classList.remove("recording");
}

/************************************************************
 * ğŸ” Dify Chatflowï¼šé€å‡ºèªéŸ³ï¼ˆsys.filesï¼‰
 ************************************************************/
async function sendToDify(blob) {
  const form = new FormData();
  form.append("query", "");
  form.append("user", USER_ID);
  form.append("response_mode", "blocking");
  if (conversationId) form.append("conversation_id", conversationId);

  form.append("file", blob, "audio.webm");

  const resp = await fetch("https://api.dify.ai/v1/chat-messages", {
    method: "POST",
    headers: {
      Authorization: "Bearer app-1WyIJ3hJBXRWb8DbTB7cbiWA"
    },
    body: form
  });

  const data = await resp.json();

  conversationId = data.conversation_id;

  document.getElementById("userText").textContent =
    data.inputs?.voice_text || "(èªéŸ³è¾¨è­˜ä¸­...)";

  document.getElementById("aiText").textContent = data.answer || "(ç„¡æ–‡å­—å›è¦†)";

  if (data.audio) {
    const audioPlayer = document.getElementById("audioPlayer");
    const audioBlob = await fetch(data.audio).then(r => r.blob());
    audioPlayer.src = URL.createObjectURL(audioBlob);
    audioPlayer.play();
  }
}
</script>
</body>
</html>
