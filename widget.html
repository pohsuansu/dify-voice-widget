<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>æ…¢æ€§ç—…é‹å‹•è™•æ–¹ï¼ˆèªéŸ³ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- WaveSurferï¼šç”¨ä¾†é¡¯ç¤ºéŒ„éŸ³æ³¢å½¢ -->
<script src="https://unpkg.com/wavesurfer.js"></script>

<style>
  body {
    font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
    background: #f5f7fb;
    margin: 0;
    padding: 40px 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #1f2937;
  }

  h1 {
    font-size: 26px;
    margin-bottom: 20px;
  }

  .record-button {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    background: #ef4444;
    color: white;
    border: none;
    font-size: 24px;
    font-weight: 700;
    cursor: pointer;
    transition: 0.2s;
  }

  .record-button.recording {
    background: #10b981;
  }

  .panel {
    width: 100%;
    max-width: 900px;
    background: #fff;
    margin-top: 24px;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  }

  audio {
    width: 100%;
    margin-top: 12px;
  }

  .bubble {
    padding: 12px;
    border-radius: 10px;
    margin-top: 8px;
    white-space: pre-wrap;
    background: #f3f4f6;
  }

  .bubble.user { border-left: 4px solid #3b82f6; }
  .bubble.ai   { border-left: 4px solid #10b981; }

  .status {
    font-size: 14px;
    margin-top: 8px;
    color: #6b7280;
  }

  #waveform {
    width: 100%;
    height: 120px;
    margin-top: 16px;
    border-radius: 10px;
    background: #f1f5f9;
  }
</style>

</head>
<body>

<h1>ğŸ™ï¸ æ…¢æ€§ç—…é‹å‹•è™•æ–¹ï¼ˆèªéŸ³ç‰ˆï¼‰</h1>

<button id="recordBtn" class="record-button">é–‹å§‹éŒ„éŸ³</button>

<div id="waveform"></div>

<div class="panel">
  <div class="status" id="status">ç‹€æ…‹ï¼šå¾…æ©Ÿ</div>

  <div style="margin-top: 12px;">
    <div>ä½ èªªçš„å…§å®¹ï¼ˆSTTï¼‰</div>
    <div class="bubble user" id="userText"></div>
  </div>

  <div style="margin-top: 12px;">
    <div>AI å›è¦†ï¼ˆLLMï¼‰</div>
    <div class="bubble ai" id="aiText"></div>
  </div>

  <audio id="audioPlayer" controls></audio>
</div>

<script>
/*************************************************
 * ğŸ” è¨­å®šï¼šåªè¦æ”¹ API key
 *************************************************/
const DIFY_API_KEY = "YOUR_DIFY_API_KEY";  // â† å¡«ï¼šapp-xxxxxxx
const USER_ID = "u-" + Math.random().toString(36).slice(2);
let conversationId = "";

/*************************************************
 * ğŸ§ WaveSurferï¼ˆéŒ„éŸ³æ³¢å½¢ï¼‰
 *************************************************/
let wave;
let waveStream;

function initWaveform() {
  wave = WaveSurfer.create({
    container: "#waveform",
    waveColor: "#cbd5e1",
    progressColor: "#0ea5e9",
    cursorWidth: 0,
    height: 120,
  });
}

/*************************************************
 * ğŸ™ ç€è¦½å™¨éŒ„éŸ³
 *************************************************/
let mediaRecorder;
let chunks = [];

const recordBtn = document.getElementById("recordBtn");
const statusEl  = document.getElementById("status");
const userText  = document.getElementById("userText");
const aiText    = document.getElementById("aiText");
const audioPlayer = document.getElementById("audioPlayer");

recordBtn.addEventListener("click", async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    startRecording();
  } else {
    stopRecording();
  }
});

async function startRecording() {
  chunks = [];
  initWaveform();

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    // æ³¢å½¢é¡¯ç¤ºä½¿ç”¨ stream
    waveStream = stream;
    wave.microphone = wave.microphone || {};
    wave.microphone.stream = stream;
    wave.microphone.init = function () {
      wave.microphone.mediaRecorder = new MediaRecorder(stream);
    };
    wave.microphone.play = function () {
      wave.microphone.init();
      wave.microphone.mediaRecorder.ondataavailable = () => {};
      wave.microphone.mediaRecorder.start();
      wave.microphone.active = true;
      wave.microphone.streamNode = wave.backend.ac.createMediaStreamSource(stream);
      wave.setFilter(wave.backend.ac.createAnalyser());
      wave.microphone.streamNode.connect(wave.filters[0]);
    };
    wave.microphone.play();

    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = (e) => chunks.push(e.data);

    mediaRecorder.onstop = async () => {
      wave.microphone.streamNode && wave.microphone.streamNode.disconnect();
      stream.getTracks().forEach(t => t.stop());

      const audioBlob = new Blob(chunks, { type: "audio/webm" });
      await processAudio(audioBlob);
    };

    mediaRecorder.start();

    recordBtn.textContent = "åœæ­¢éŒ„éŸ³";
    recordBtn.classList.add("recording");
    setStatus("éŒ„éŸ³ä¸­â€¦");

  } catch (err) {
    alert("ç„¡æ³•ä½¿ç”¨éº¥å…‹é¢¨ï¼š" + err);
  }
}

function stopRecording() {
  mediaRecorder.stop();
  recordBtn.disabled = true;
  setStatus("åˆ†æèªéŸ³ä¸­â€¦");
}

function setStatus(text) {
  statusEl.textContent = "ç‹€æ…‹ï¼š" + text;
}

/*************************************************
 * ğŸ” å‰ç«¯ â†’ Chatflowï¼ˆé™„ä¸Š sys.filesï¼‰
 *************************************************/
async function sendAudioToDify(blob) {
  const form = new FormData();
  form.append("query", "");          // èªéŸ³è¼¸å…¥æ™‚ query ç‚ºç©º
  form.append("user", USER_ID);
  form.append("response_mode", "blocking");
  form.append("conversation_id", conversationId);

  form.append("file", blob, "audio.webm");

  const resp = await fetch("https://api.dify.ai/v1/chat-messages", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + DIFY_API_KEY
    },
    body: form
  });

  if (!resp.ok) throw new Error(await resp.text());
  return resp.json();
}

/*************************************************
 * ğŸ¯ æ•´åˆæµç¨‹ï¼šSTT â†’ LLM â†’ TTS
 *************************************************/
async function processAudio(blob) {
  try {
    // å‘¼å« Chatflowï¼ˆSTT æœƒåœ¨ Chatflow å…§è§¸ç™¼ Whisper_STTï¼‰
    const result = await sendAudioToDify(blob);

    // æ›´æ–°å°è©± ID
    if (result.conversation_id) conversationId = result.conversation_id;

    // å‰ç«¯é¡¯ç¤º STT / LLM
    userText.textContent = result.inputs?.voice_text || "(èªéŸ³å·²è¾¨è­˜)";
    aiText.textContent = result.answer || "(æ²’æœ‰æ–‡å­—å›è¦†)";

    // æ’­æ”¾èªéŸ³ï¼ˆTTS å·²ç”± Chatflow ç”¢ç”Ÿï¼‰
    if (result.audio) {
      const blob = await fetch(result.audio).then(r => r.blob());
      audioPlayer.src = URL.createObjectURL(blob);
      audioPlayer.play();
    }

    setStatus("å®Œæˆï¼Œå¯ä»¥å†æ¬¡éŒ„éŸ³");

  } catch (err) {
    setStatus("ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
  } finally {
    recordBtn.disabled = false;
    recordBtn.textContent = "é–‹å§‹éŒ„éŸ³";
    recordBtn.classList.remove("recording");
  }
}
</script>

</body>
</html>
