<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>èªéŸ³èŠå¤©å°å·¥å…·</title>
<style>
    body { font-family: sans-serif; text-align: center; padding-top: 80px; }
    .mic-btn {
        width: 180px; height: 180px;
        background: #e85a54; color: #fff;
        border-radius: 50%; border: none;
        font-size: 28px; cursor: pointer;
        box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    }
    audio { margin-top: 40px; width: 90%; }
</style>
</head>

<body>

<h2>ğŸ¤ æ…¢æ€§ç—…é‹å‹•è™•æ–¹ï¼ˆèªéŸ³ç‰ˆï¼‰</h2>
<button id="recordBtn" class="mic-btn">é–‹å§‹éŒ„éŸ³</button>

<div id="textDisplay" style="margin-top:40px;font-size:20px;color:#333"></div>
<audio id="audioPlayer" controls></audio>

<script>
const DIFY_API_KEY = "app-xr8iBjv5WWgb18WD128ZqCVg";   // â˜… é€™æ˜¯ä½ å”¯ä¸€è¦æ”¾çš„é‡‘é‘°
const DIFY_CHAT_URL = "https://udify.app/chat/nDfhp6v0WgHFH2Y3";

let mediaRecorder;
let audioChunks = [];

document.getElementById("recordBtn").onclick = async () => {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
        startRecording();
    } else {
        stopRecording();
    }
};

async function startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = sendToDify;

    mediaRecorder.start();
    document.getElementById("recordBtn").innerText = "åœæ­¢éŒ„éŸ³";
}

function stopRecording() {
    mediaRecorder.stop();
    document.getElementById("recordBtn").innerText = "é–‹å§‹éŒ„éŸ³";
}

async function sendToDify() {
    const blob = new Blob(audioChunks, { type: "audio/webm" });

    let form = new FormData();
    form.append("file", blob, "audio.webm");
    form.append("response_mode", "blocking");
    form.append("user", "elder-user");

    const res = await fetch(DIFY_CHAT_URL, {
        method: "POST",
        headers: { Authorization: `Bearer ${DIFY_API_KEY}` },
        body: form
    });

    const json = await res.json();

    console.log(json);

    // é¡¯ç¤ºæ–‡å­—ï¼ˆLLM replyï¼‰
    document.getElementById("textDisplay").innerText =
        json.answer || "(æœªæ”¶åˆ°æ–‡å­—çµæœ)";

    // æ’­æ”¾ TTS éŸ³è¨Š
    if (json?.audio?.data) {
        const audioData = json.audio.data; // base64
        const audioBlob = base64ToBlob(audioData, "audio/mpeg");
        const url = URL.createObjectURL(audioBlob);
        document.getElementById("audioPlayer").src = url;
    }
}

function base64ToBlob(base64, type) {
    const bin = atob(base64);
    const arr = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
    return new Blob([arr], { type });
}
</script>

</body>
</html>
