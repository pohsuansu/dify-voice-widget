<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Dify Voice Assistant</title>
<style>
  body { font-family: sans-serif; padding: 10px; }
  #recordBtn {
    background: #4CAF50;
    color: white; padding: 12px 20px;
    border: none; border-radius: 8px;
    font-size: 18px; cursor: pointer;
  }
  #recordBtn.active { background: #E53935; }
  #reply { margin-top: 20px; font-size: 18px; white-space: pre-wrap; }
</style>
</head>

<body>
<h2>ğŸ¤ AI é‹å‹•è™•æ–¹èªéŸ³åŠ©ç†</h2>
<button id="recordBtn">ğŸ¤ é–‹å§‹èªªè©±</button>
<audio id="player" controls style="width:100%; margin-top:20px;"></audio>
<div id="reply"></div>

<script>
let recorder, chunks = [];

const recordBtn = document.getElementById("recordBtn");
const player = document.getElementById("player");
const replyBox = document.getElementById("reply");

recordBtn.onclick = async () => {
  if (!recorder) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream);
    recorder.ondataavailable = e => chunks.push(e.data);

    recorder.onstop = async () => {
      recordBtn.textContent = "ğŸ¤ é–‹å§‹èªªè©±";
      recordBtn.classList.remove("active");

      const blob = new Blob(chunks, { type: "audio/wav" });
      chunks = [];
      const arrayBuf = await blob.arrayBuffer();
      const base64Audio = btoa(String.fromCharCode(...new Uint8Array(arrayBuf)));

      // --- å‘¼å« Dify Workflow ---
      const response = await fetch(
        "https://api.dify.ai/v1/workflows/YOUR_WORKFLOW_ID/run",
        {
          method: "POST",
          headers: {
            "Authorization": "Bearer YOUR_API_KEY",
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            inputs: { audio_base64: base64Audio }
          })
        }
      );

      const result = await response.json();
      console.log("Dify Result:", result);

      const text = result.data?.outputs?.reply_text || "(æ²’æœ‰æ–‡å­—å›è¦†)";
      const audio = result.data?.outputs?.reply_audio || null;

      replyBox.textContent = "ğŸ—£ å›è¦†å…§å®¹ï¼š\n" + text;

      if (audio) {
        player.src = "data:audio/mp3;base64," + audio;
        player.play();
      }
    };
  }

  if (recorder.state === "inactive") {
    recordBtn.textContent = "ğŸ›‘ åœæ­¢éŒ„éŸ³";
    recordBtn.classList.add("active");
    recorder.start();
  } else {
    recorder.stop();
  }
};
</script>
</body>
</html>
