<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>èªéŸ³é‹å‹•è™•æ–¹åŠ©æ‰‹</title>
<style>
body {
    font-family: system-ui;
    background: #f5f7fc;
    text-align: center;
    padding: 30px;
}

#recordBtn {
    background: #e65352;
    color: white;
    border: none;
    border-radius: 50%;
    width: 220px;
    height: 220px;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 8px 18px rgba(0,0,0,0.1);
}

#waveform {
    margin: 30px auto;
    width: 90%;
    height: 130px;
    background: #dde2ea;
    border-radius: 12px;
}
.box {
    background: white;
    width: 90%;
    margin: 15px auto;
    padding: 14px;
    border-radius: 12px;
    text-align: left;
    font-size: 20px;
}
</style>
</head>

<body>

<h2>ğŸ¤ èªéŸ³é‹å‹•è™•æ–¹ åŠ©ç† 251117 13:30</h2>

<button id="recordBtn">é–‹å§‹éŒ„éŸ³</button>

<canvas id="waveform"></canvas>

<div class="box"><b>ä½ èªªï¼š</b> <span id="userText">(å°šæœªè¼¸å…¥)</span></div>
<div class="box"><b>AI å›è¦†ï¼š</b> <span id="aiText">(å°šæœªå›è¦†)</span></div>

<audio id="audioPlayer" controls></audio>

<script>
/* -------------------------
   âš™ï¸ CONFIG
------------------------- */
const DIFY_API_KEY = "app-1WyIJ3hJBXRWb8DbTB7cbiWA";
const API_URL = "https://api.dify.ai/v1/chat-messages";
let conversationId = null;

/* -------------------------
   ğŸ™ï¸ éŒ„éŸ³ + æ³¢å½¢
------------------------- */
let mediaRecorder, audioChunks = [];
let audioContext, analyser, dataArray;

const canvas = document.getElementById("waveform");
const ctx = canvas.getContext("2d");
canvas.width = canvas.offsetWidth;
canvas.height = canvas.offsetHeight;

function drawWaveform() {
    requestAnimationFrame(drawWaveform);
    if (!analyser) return;

    analyser.getByteTimeDomainData(dataArray);

    ctx.fillStyle = "#dde2ea";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.lineWidth = 3;
    ctx.strokeStyle = "#667aff";
    ctx.beginPath();

    let slice = canvas.width * 1.0 / analyser.bufferLength;
    let x = 0;

    for (let i = 0; i < analyser.bufferLength; i++) {
        let v = dataArray[i] / 128.0;
        let y = v * canvas.height/2;

        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);

        x += slice;
    }
    ctx.stroke();
}

async function startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioChunks = [];

    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start();

    const source = (audioContext = new AudioContext()).createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    dataArray = new Uint8Array(analyser.fftSize);
    source.connect(analyser);
    drawWaveform();

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = sendAudioToDify;

    document.getElementById("recordBtn").textContent = "åœæ­¢éŒ„éŸ³";
}

function stopRecording() {
    mediaRecorder.stop();
    document.getElementById("recordBtn").textContent = "é–‹å§‹éŒ„éŸ³";
}

/* -------------------------
   ğŸš€ é€èªéŸ³çµ¦ Difyï¼ˆæœ€é‡è¦çš„ä¿®æ­£ï¼‰
------------------------- */
async function sendAudioToDify() {
    const blob = new Blob(audioChunks, { type: "audio/webm" });

    const form = new FormData();
    form.append("response_mode", "blocking");
    form.append("user", "voice-user-001");

    if (conversationId)
        form.append("conversation_id", conversationId);

    // ğŸ”¥ğŸ”¥ğŸ”¥ é—œéµä¿®æ­£ï¼šã€Œfilesã€ä¸æ˜¯ file
    form.append("files", blob, "audio.webm");

    const resp = await fetch(API_URL, {
        method: "POST",
        headers: { Authorization: `Bearer ${DIFY_API_KEY}` },
        body: form
    });

    const data = await resp.json();

    if (!resp.ok) {
        alert("âŒ Dify å›æ‡‰éŒ¯èª¤ï¼š" + resp.status + " - " + JSON.stringify(data));
        return;
    }

    conversationId = data.conversation_id;

    document.getElementById("userText").textContent =
        data.inputs?.voice_text || "(èªéŸ³è¾¨è­˜ä¸­...)";

    document.getElementById("aiText").textContent =
        data.answer || "(AI æ²’æœ‰æ–‡å­—å›è¦†)";

    // ğŸ§ æ’­æ”¾èªéŸ³å›è¦†
    if (data.audio) {
        const audioBlob = await fetch(data.audio).then(r => r.blob());
        const player = document.getElementById("audioPlayer");
        player.src = URL.createObjectURL(audioBlob);
        player.play();
    }
}

/* -------------------------
   ğŸ›ï¸ UI ç¶å®š
------------------------- */
document.getElementById("recordBtn").addEventListener("click", () => {
    if (!mediaRecorder || mediaRecorder.state === "inactive") startRecording();
    else stopRecording();
});
</script>

</body>
</html>
